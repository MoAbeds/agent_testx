rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- SITES ---
    match /sites/{siteId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // --- EVENTS ---
    match /events/{eventId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(resource.data.siteId)).data.userId == request.auth.uid;
      
      // ðŸ”’ SECURITY FIX: Only allow creation if the siteId belongs to the requester
      // or if it's coming from an authorized server-side handshake (which we handle via Admin SDK)
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(request.resource.data.siteId)).data.userId == request.auth.uid;
        
      allow update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(resource.data.siteId)).data.userId == request.auth.uid;
    }

    // --- USERS ---
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // ðŸ”’ HARD SECURITY: Block users from updating their own PLAN or SUBSCRIPTION
      // Users can only create their initial profile (which defaults to FREE)
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId 
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['plan', 'subscriptionId']);
    }

    // --- PAGES ---
    match /pages/{docId} { 
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(resource.data.siteId)).data.userId == request.auth.uid;
    }
    
    // --- RULES ---
    match /rules/{docId} { 
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(resource.data.siteId)).data.userId == request.auth.uid;
    }
    
    // --- WEBHOOKS ---
    match /webhooks/{docId} { 
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/sites/$(resource.data.siteId)).data.userId == request.auth.uid;
    }

    // --- DENY EVERYTHING ELSE BY DEFAULT ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
